---
# tasks file for kea
- block:
  - name: Include installation
    include_tasks: debian_install.yml
  when: kea_install

- block:
  - name: check db schema version
    ansible.builtin.command:
      cmd: "kea-admin db-version pgsql -u {{ kea_pg.user }} -p {{ kea_pg.password }} -n {{ kea_pg.name }}"
    register: dbversion
    no_log: true

  - name: postgres prep
    ansible.builtin.command:
      cmd: "kea-admin db-init pgsql -u {{ kea_pg.user }} -p {{ kea_pg.password }} -n {{ kea_pg.name }}"
    when: dbversion.stdout == ''
    no_log: true

  when: kea_pg

- name: validation script
  ansible.builtin.copy:
    dest: /usr/local/bin/validate.sh
    content: |
      #!/bin/env bash
      FIL=${@: -1}
      cp $FIL /tmp/sample.conf
      $@
    owner: root
    group: root
    mode: '0755'

- block:
  # - name: DHCP4 Details Configuration
  #   ansible.builtin.template:
  #     src: dhcp4-details.conf.j2
  #     dest: /etc/kea/dhcp4-details.conf
  #     mode: '0640'
  #     owner: "{{ kea_user }}"
  #     group: "{{ kea_group }}"
  #   notify: restart dhcp4

  - name: Configure DHCP 4 
    ansible.builtin.template:
      src: kea-dhcp4.conf.j2
      dest: /etc/kea/kea-dhcp4.conf
      mode: '0640'
      owner: "{{ kea_user }}"
      group: "{{ kea_group }}"
      validate: "validate.sh kea-dhcp4 -t %s"
    notify: restart dhcp4

- block:
  # - name: DHCP6 Details Configuration
  #   ansible.builtin.template:
  #     src: dhcp6-details.conf.j2
  #     dest: /etc/kea/dhcp6-details.conf
  #     mode: '0640'
  #     owner: "{{ kea_user }}"
  #     group: "{{ kea_group }}"
  #   notify: restart dhcp6

  - name: Configure DHCP 6
    ansible.builtin.template:
      src: kea-dhcp6.conf.j2
      dest: /etc/kea/kea-dhcp6.conf
      mode: '0640'
      owner: "{{ kea_user }}"
      group: "{{ kea_group }}"
      validate: "validate.sh kea-dhcp6 -d -t %s"
    notify: restart dhcp6

- block:
  - name: Configure tsig-keys
    ansible.builtin.template:
      src: tsig-keys.json.j2
      dest: /etc/kea/tsig-keys.json
      mode: '0640'
      owner: "{{ kea_user }}"
      group: "{{ kea_group }}"
    notify: restart dhcp-ddns

  - name: Configure dhcp-ddns
    ansible.builtin.template:
      src: kea-dhcp-ddns.conf.j2
      dest: /etc/kea/kea-dhcp-ddns.conf
      mode: '0640'
      owner: "{{ kea_user }}"
      group: "{{ kea_group }}"
      validate: "kea-dhcp-ddns -t %s"
    notify: restart dhcp-ddns
  when: (kea_dhcp4_ddns | bool) or (kea_dhcp6_ddns | bool)


- name: Configure Ctrl Agent
  ansible.builtin.template:
    src: kea-ctrl-agent.conf.j2
    dest: /etc/kea/kea-ctrl-agent.conf
    mode: '0640'
    owner: "{{ kea_user }}"
    group: "{{ kea_group }}"
    validate: "kea-ctrl-agent -t %s"
  notify: restart ctrl agent
