---
# tasks file for kea
- block:
  - name: Include installation
    include_tasks: debian_install.yml
  when: kea_install

- block:
  - name: check db schema version
    ansible.builtin.command:
      cmd: "kea-admin db-version pgsql -u {{ kea_pg.user }} -p {{ kea_pg.password }} -n {{ kea_pg.name }}"
    register: dbversion
    no_log: true
    
  - name: postgres prep
    ansible.builtin.command:
      cmd: "kea-admin db-init pgsql -u {{ kea_pg.user }} -p {{ kea_pg.password }} -n {{ kea_pg.name }}"
    when: dbversion.stdout == ''
    no_log: true
    
  when: kea_pg

- block:
  - name: DHCP4 Details
    ansible.builtin.template:
      src: dhcp4-details.conf.j2
      dest: /etc/kea/dhcp4-details.conf
      mode: '0640'
      owner: "{{ kea_user }}"
      group: "{{ kea_group }}"
    notify: reload dhcp4
  
  - name: Configure DHCP 4
    ansible.builtin.template:
      src: kea-dhcp4.conf.j2
      dest: /etc/kea/kea-dhcp4.conf
      mode: '0640'
      owner: "{{ kea_user }}"
      group: "{{ kea_group }}"
      validate: "kea-dhcp4 -t %s"
    notify: restart dhcp4


- block:  
  - name: DHCP6 Details
    ansible.builtin.template:
      src: dhcp6-details.conf.j2
      dest: /etc/kea/dhcp6-details.conf
      mode: '0640'
      owner: "{{ kea_user }}"
      group: "{{ kea_group }}"
    notify: reload dhcp6 
    
  - name: Configure DHCP 6
    ansible.builtin.template:
      src: kea-dhcp6.conf.j2
      dest: /etc/kea/kea-dhcp6.conf
      mode: '0640'
      owner: "{{ kea_user }}"
      group: "{{ kea_group }}"
      validate: "kea-dhcp6 -t %s"
    notify: restart dhcp6
    
  
- name: Configure Ctrl Agent
  ansible.builtin.template:
    src: kea-ctrl-agent.conf.j2
    dest: /etc/kea/kea-ctrl-agent.conf
    mode: '0644'
    owner: "{{ kea_user }}"
    group: "{{ kea_group }}"
    validate: "kea-ctrl-agent -t %s"
  notify: restart ctrl agent
  
  
- name: Configure dhcp-ddns
  ansible.builtin.template:
    src: kea-dhcp-ddns.conf.j2
    dest: /etc/kea/kea-dhcp-ddns.conf
    mode: '0644'
    owner: "{{ kea_user }}"
    group: "{{ kea_group }}"
    validate: "kea-dhcp-ddns -t %s"
  notify: restart dhcp-ddns